## Next.js + EC2를 이용하여 배포하기

### Next.js로 마이그레이션

- 기존 프로젝트에 next 설치

  ```bash
  npm uninstall react-scripts react-router-dom
  npm install next
  ```

- Package.json scripts 설정

  ```bash
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  ```

- next 디렉토리 구조에 맞춰 파일 수정

  ```
  public > static assets를 모아둠.

  pages > {컴포넌트 명}.js or {컴포넌트 명}/index.js > 컴포넌트 명이 라우팅 pathname. 파일시스템 기반 라우팅.

  pages/_document.js > <head>에 메타태그를 설정하거나 <body>에 들어갈 내용을 적어주는 등의 용도.

  pages/_app.js > 내비게이션 같이 모든 페이지에 공통으로 적용하고 싶은 레이아웃 추가.
  ```

- 실행

  ```bash
  $ npm build && npm start
  ```

### EC2 인스턴스 생성하기

- Amazon EC2 > 인스턴스 시작

- 인스턴스 설정

  ```
  Amazone Machine Image 선택 > Ubuntu Server 18.04 LTS (HVM), SSD Volume Type

  인스턴스 유형 > t2.micro 혹은 t2.medium

  인스턴스 구성 > VPC : TECHCOURSE, 서브넷 : TRAINING, 퍼블릭 IP 자동할당 : 활성화

  스토리지 추가 > 스킵

  태그 추가 > 키 : Name, 값: 원하는 인스턴스 명

  보안 그룹 > 기존 보안 그룹 > SG-DEFAULT

  검토 > 시작하기 클릭

  키 페어 > 키 페어 생성하기 > pem 키 저장
  ```

### EC2 환경에 접속하기

- pem 키가 저장된 디렉토리로 이동

  ```bash
  $ chmod 400 KEY-{만든 키 이름}.pem
  $ ssh -i "KEY-something.pem" {인스턴스 퍼블릭 DNS}
  ```

### 프로젝트 세팅

- node & npm 설치

  ```bash
  $ sudo apt-get update
  $ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
  $ . ~/.nvm/nvm.sh
  $ nvm install node
  ```

- 프로젝트 클론
  ```bash
  $ git clone https://github.com/{레포지토리}
  $ git checkout {브랜치}
  $ npm run build && npm start
  ```

### PM2 설정하기 (프로세스 background 실행)

- pm2 설치

  ```bash
  $ npm install pm2 -g
  ```

- pm2 프로세스 설정

  ```bash
  pm2 start npm --name "next" -- start
  ```

### Nginx 설정

- Nginx 설치

  ```bash
  $ sudo apt-get install nginx
  $ sudo service nginx start
  ```

- 디렉토리 이동 > /etc/nginx/sites-available/default 파일 변경

  ```bash
  cd /etc/nginx/sites-available
  ```

  ```
  // default

  server {
    listen 80;
    listen [::]:80;

    server_name {도메인이 있다면 추가}

    location / {
      proxy_pass http://127.0.0.1:{현재 사용 중인 포트 번호}
    }
  }
  ```

- Nginx 재시작

  ```bash
  $ sudo service nginx restart
  ```

### https 연결 (Certbot)

- Certbot 설치

  ```bash
  $ sudo apt-get install python3-certbot-nginx
  ```

- Certbot 설정

  ```bash
  $ sudo certbot --nginx

  [1 - 2] 중 택 1 > 2번 선택(자동으로 nginx 설정)
  ```

- Nginx 재시작

  ```bash
  $ sudo service nginx restart
  ```
